+++
title = "Sound on BEAM: Music in the Land of Distributed Lisp"
outputs = ["Reveal"]

[logo]
src = "logo-v6.svg"
+++

# Sound on BEAM: Music in the Land of Distributed Lisp

[//]: Speaker-Notes:
{{% note %}}
Welcome to the talk!

My name is Duncan McGreggor, and today I'm going to share with you a little
of Lisp Flavoured Erlang, some Extempore, music synthesis and
recording, and how they all come together in the undertone project.

{{% /note %}}

---

## Overview

* Introduction
* undertone, its architecture, and its uses
* Functional programming, mutable state, and I/O
* Intermission Q & A

[//]: Speaker-Notes:
{{% note %}}

{{% /note %}}

---

## Overview

* Sound synthesis as functional programming
* Systems control for music
* Demo
* What's next for undertone
* Final Q & A

[//]: Speaker-Notes:
{{% note %}}

{{% /note %}}

---

## Who am I?

* Prinicpal software engineer
* Life-long hacker (started at age 9 in '81; never stopped)
* Habbitual explorer
* Core contributor to Robert Virding's Lisp Flavoured Erlang (LFE)

---

## Why am I talking about music?

* ❤️Maths (school)
* ❤️Functional Programming (career)
* ❤️Music (...)
* (& ❤️Lisp)

[//]: Speaker-Notes:
{{% note %}}
The last musical performance I gave was as the pianist in a chamber music quartest when I was 17. 

In my 20s, I built a hobbyist home recording studio. This was the early-to-mid-90s, so everything was analog.
{{% /note %}}

---

## Why this topic?

<img src="dm_as_1.jpg" /> <img src="dm_as_2.jpg" />

{{% note %}}
Then, when I was 42, I met Andrew Sorensen after his Extempore live-coding performance at OSCON 2014,
created a variation on his piece, and thus began a slow-reignition of my passion for music.

Now playing my two main instruments again, even taking courses.ss
{{% /note %}}

---

## What is undertone?

<img src="teaser_video_daw.jpg" />

{{% note %}}
In my 2021 Lambda Days "teaser" video some of you may have seen, there are 9 seperate tracks of synthesizer being played. All of those were generated by undertone.
{{% /note %}}

---

## What is undertone?

<ul>
<li>That music you heard? That.</li>
<li class="fragment">Sort of.</li>
<li class="fragment">Lots of software synthesizers, played via MIDI.</li>
<li class="fragment">Routed by Extempore.</li>
<li class="fragment">Over TCP.</li>
<li class="fragment">It's complicated.</li>
</ul>


{{% note %}}
{{% /note %}}


---

## Architecture

<img src="arch/system-context.jpg" style="width: 100%" />

[//]: Speaker-Notes:
{{% note %}}
Here's a diagram of the system context for undertone.
{{% /note %}}

---

## Architecture

System context for undertone:

* uses Erlang (starts up supervision tree, clients, servers)
* talks to Extempore (bitstrings over TCP)
* controls OSC servers (e.g., DAWs)

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Architecture

System context for Extempore:

* talks to the OS / routes MIDI
* signals routed to external devices
* also routed to MIDI in the DAW (e.g., software synthesizers)

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Architecture

<img src="arch/system-context.jpg" style="width: 100%" />

[//]: Speaker-Notes:
{{% note %}}
Now, if we zoom in ...
{{% /note %}}

---

## Architecture

<img src="arch/system-context-zoom.jpg" style="width: 100%" />

[//]: Speaker-Notes:
{{% note %}}
... on undertone's purple box, or "container" ...
{{% /note %}}

 
---
 
## Architecture

<img src="arch/containers.jpg" style="width: 100%" />

[//]: Speaker-Notes:
{{% note %}}
We can see a little more of what's going on under the bonnet.
{{% /note %}}

---
 
## Architecture

<img src="arch/erlang-node-diagram.jpg" />

[//]: Speaker-Notes:
{{% note %}}
We can see a little more of what's going on under the bonnet.
{{% /note %}}

---

## Architecture

The undertone "container":

* OTP app with supervisor and state server
* State server for mananging session commands and system config
* OSC clients for any OSC-enabled software running a UDP server
* TCP client for long-running connections to Extempore
* LFE REPL
* Extempore REPL

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Aside: Extempore vs SuperCollider

<ul>
<li class="fragment">Better UX in Extempore</li>
<li class="fragment">Scheme vs Curly-brace/C-inspired scipring language</li>
<li class="fragment">Musical orientation vs data / numbers / structs</li>

</ul>

[//]: Speaker-Notes:
{{% note %}}
My perception of a better user experience in Extempore admittedly may be due to the next bullet ...

And the view that Extempore feels more musical is purely down to personal preference; but you may feel the same if you watch Andrew Sorensen create a dynamic musical piece in preconfigured scales and modes!
{{% /note %}}

---

## Ways to Use undertone

<ul>
<li>Controlling.</li>
<li class="fragment">Playing.</li>
<li class="fragment">And controlling.</li>
<li class="fragment">And more playing.</li>
</ul>


[//]: Speaker-Notes:
{{% note %}}
In undertone, you're using code to issue commands to Extempore or your DAW or connected devices. These commands then let you play various musical sources.

Comfort at this level then pushes you to do more, such as adjusting the sounds as they are being played -- another type of control.

And when you can control your music like this, at nearly meta-levels, you can play in new and different ways.

A very clear example of systems feedback :-) 
{{% /note %}}

---

## Using for personal interest

* Long, slow looping music in given keys, but random notes or intervals
* Accompanyment for practice
* Jam sessions
* Endless, non-repeating background, ambient music



[//]: Speaker-Notes:
{{% note %}}
Since this is for fun, and the love of the art, I want to do it in a manner I will enjoy.
{{% /note %}}

---

{{< slide background-image="LFE-logo-darker-greys-0.05trans-6-square-x3000.png" >}}

## Aside: Erlang & LFE

An example: a recursive function using pattern-matching in the function heads.

#### Erlang

```erlang
ackermann(0, N) ->
  N+1;
ackermann(M, 0) ->
  ackermann(M-1, 1);
ackermann(M, N) when M > 0 andalso N > 0 ->
  ackermann(M-1, ackermann(M, N-1)).
```

#### LFE

```clj
(defun ackermann
  ((0 n) (+ n 1))
  ((m 0) (ackermann (- m 1) 1))
  ((m n) (ackermann (- m 1) (ackermann m (- n 1)))))
```

[//]: Speaker-Notes:
{{% note %}}
Shortly, I'll be showing you some LFE code that will generate music.

As such, it might make sense to provide you with a little insight, context, or compare / contrast with Erlang.
{{% /note %}}

---

## FP in an I/O World

Extempore provides deep and permissive control over its state, components, and systems.

[//]: Speaker-Notes:
{{% note %}}
Extempore maintains the global state necessary to create music using XXX
{{% /note %}}

---

## FP in an I/O World

Extempore's xtlang:

``` scheme
(bind-func AudioBuffer_data_b64
  (lambda (ab:AudioBuffer*)
    (let ((b64size:i64 0)
          (datsize:i64 (* (AudioBuffer_frames ab)
                          (AudioBuffer_channels ab) 4)))
      (String (base64_encode (cast (tref ab 4) i8*)
                             datsize
                             (ref b64size))))))
```

[//]: Speaker-Notes:
{{% note %}}
For deep access to Extempore and its data, a C-like Scheme extension is provided
{{% /note %}}

---

## FP in an I/O World

Extempore's Scheme:

``` scheme
(sys:load "libs/external/portmidi.xtm")
(pm_initialize)
(define *midi-out* (pm_create_output_stream 3))

(define midi-loop
  (lambda (beat dur)
    (mplay *midi-out*
           (random (list 36 43 48 51 60 60 60 67 70 74 75))
           (random 60 80)
           dur 0)
    (callback (*metro* (+ beat (* .5 dur)))
              'midi-loop
              (+ beat dur)
              dur)))

(midi-loop (*metro* 'get-beat 4) 1/4)

(define midi-loop
  (lambda (beat dur) #t))
```

[//]: Speaker-Notes:
{{% note %}}
Most Extempore performers use the higher-level Scheme dialect, due to its musical orientation and conveniences.

This code could serve as the basis for creating some interesting generative music. Note the actions being taken outside the context of functions, though: It is geared toward performance and quickly / easily manipulating global state.

However, if I wanted to do something more complex, like use this as the basis for creating a step sequencer, with potentially many MIDI channels and / or devices, I'd be in for a lot of jumping around, tracking many sets of global variables for each sequencer I wanted to use, etc.
{{% /note %}}

---

{{< slide background-image="LFE-logo-darker-greys-0.05trans-6-square-x3000.png" >}}

## FP in an I/O World

An LFE sequencer in undertone:

``` lisp
(set opts (xt.seq:midi-opts sequence-name
                            device-name
                            device-id
                            midi-channel
                            seq1
                            pulse1
                            beats-per-minute
                            beats-per-measure
                            note-timing))
(xt.seq:start opts)
(xt.midi:cc-ramp (mupd opts 'cc-code (cutoff-filter-1)) 15 40 5)
(xt.seq:set-midi-notes! (mupd opts 'notes '(c3 c3 c4  c4 a#3 g3)))
```

---
## FP in an I/O World

<img src="lol_clean_fp.jpg" />

[//]: Speaker-Notes:
{{% note %}}
So why would someone go through all the effort to put a functional wrapper around so much I/O and global, mutable state?

Functional Programming meets musical composition:

* better (more disciplined) control over the control global environment

{{% /note %}}

---

## Intermission

<img src="intermission/Let's_All_Go_to_the_Lobby.jpg" style="width: 80%" />

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Review

* {{< fa check-square >}} Introduction
* {{< fa check-square >}} undertone, its architecture, and its uses
* {{< fa check-square >}} Functional programming, mutable state, and I/O
* {{< fa check-square >}} Intermission Q & A

[//]: Speaker-Notes:
{{% note %}}

{{% /note %}}

---

## Next

* Sound synthesis as functional programming
* Systems control for music
* Demo
* What's next for undertone
* Final Q & A

[//]: Speaker-Notes:
{{% note %}}

{{% /note %}}

---

## Synthesis as Functional Programming

<img src="lol_beautiful_fp.jpg" />

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Synthesis as Functional Programming

<img src="basicpatch.jpg" />

[//]: Speaker-Notes:
{{% note %}}
The signal chain goes from left to right. MIDI provides the notes to the MIDI interface which produces pitch and gate signals. The pitch signal controls the Oscillator and the ramp waveform from the oscillator goes into the filter. The filter changes harmonics of the ramp wave and the filtered output goes on to the  Amplifier where the signals amplitude is controlled. Since gate needs to go to two places, it's patched through a Multiple which is just a patch bay. The gates then go to two envelope generators. One generator controls the filter and the other controls the amplitude. 
{{% /note %}}

---

## Synthesis as Functional Programming

<img src="synthpatch_1000.png" />

[//]: Speaker-Notes:
{{% note %}}
Here's a logical digram of the previous patch cable diagram.
{{% /note %}}

---

## Synthesis as Functional Programming

<img src="modular-v.jpg" />

[//]: Speaker-Notes:
{{% note %}}
This is a screenshot of one of the virtual syntesizers I use, showing a very simple patch.

The same logic applies, with the various modules producing outputs that become the inputs of other modules.

In fact, this is one of the patches that I'll be demo'ing in a bit.
{{% /note %}}

---

## Synthesis as Functional Programming

<img src="keith-emerson.jpg" />

[//]: Speaker-Notes:
{{% note %}}
Then there's taking the thing to its logical extreme ...

which gives you Keith Emerson of Emerson, Lake, and Palmer.

Oh, what a lucky man he was ...
{{% /note %}}

---

## What Can undertone Do?

<img src="kronos-lfe-undertone.jpg" /> <img src="model-d-lfe-undertone.jpg" />

[//]: Speaker-Notes:
{{% note %}}
Control external MIDI devices.
{{% /note %}}

---

## What Can undertone Do?

<img src="ardour-daw.png" /> 

[//]: Speaker-Notes:
{{% note %}}
Use its Open Sound Control to move faders and tweak plugins in Digital Audio Workstations that support OSC, such as this one. This is the Ardour DAW.
{{% /note %}}

---

## Demo Time

<img src="lol-space-music.jpg" />

Now, for some space music!

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Demo Time

<img src="lol-space-music.jpg" />

1. Creating a "space orchestra" with note transformations and multiple channels: see [teaser video](https://www.youtube.com/watch?v=cfpAsvHW2i4&t=56s)

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Demo Time

<img src="lol-space-music.jpg" />

2. Using `xt.midi:cc-ramp` to simulate turning the knobs on an analog synth: Dallas/Fort Worth BEAMers Meetup demo

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Demo Time

<img src="lol-space-music.jpg" />

3. Towards generative music with Markov chains and chords: [HD video + sound]() (posting on Twitter now ...)

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## What's Next for undertone?

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Land of Lisp

Special thanks to Conrad Barski, M.D. <br />
for his kind permission in using images from his book in this talk.

Buy it! http://landoflisp.com/

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

## Q & A

[//]: Speaker-Notes:
{{% note %}}
{{% /note %}}

---

#### Contact

* {{< fa envelope >}} oubiwann@gmail.com
* {{< fa fab twitter-square >}} [@oubiwann]()
* {{< fa fab linkedin >}} [linkedin.com/in/oubiwann]()
* {{< fa fab twitter-square >}} [@forgottentones]()
* {{< fa fab soundcloud >}} https://soundcloud.com/forgotten-tones/tracks

[//]: Speaker-Notes:
{{% note %}}
Here's how you can reach me ...
{{% /note %}}

---

#### LFE Resources

* {{< fa globe >}} https://lfe.io/
* {{< fa fab github-square >}} https://github.com/rvirding/lfe
* {{< fa fab slack >}} [lfe.slack.com]()
* {{< fa users >}} http://groups.google.com/group/lisp-flavoured-erlang
* {{< fa fab twitter-square >}} [@ErlangLisp]()

[//]: Speaker-Notes:
{{% note %}}
Here's where stuff is ...
{{% /note %}}

---

#### undertone Resources

* {{< fa fab github-square >}} https://github.com/ut-proj/undertone
* {{< fa fas book >}} https://undertone.lfe.io/book
* {{< fa fab slack >}} [lfe.slack.com]() #algo-sound
* {{< fa users >}} http://groups.google.com/group/lfe-undertone
* {{< fa fab twitter-square >}} [@lfeundertone]()
* {{< fa fab instagram >}} https://www.instagram.com/lfeundertone/

---

{{% note %}}

## Overview

* Background, sound in the digital world, etc.
* Homage: Joe Armstrong's explorations
* Extempore vs. SuperCollider
* Lisp Flavoured Erlang 2.0
* Extempore in OTP
* Making Music

[//]: Speaker-Notes:


## Background (me)

* 4 yo - Messing about with Piano
* 8 yo - Started formal piano lessons, casual guitar
* 16 yo - Performed in a chamber music group
* 22 yo - Assembled a home recording studio
* 25 yo - Stopped playing music, replaced with physics / maths studies
* 48 yo - Started playing again

[//]: Speaker-Notes:


## Terminology

#### Algorithmic Composition

=?=

#### Generative Music

[//]: Speaker-Notes:


## Background (generative music)

<ul>
<li class="fragment">1957 - Max Mathews MUSIC-1 on the IBM 704</li>
<li class="fragment">(1958 - LISP, also on the IBM 704)</li>
<li class="fragment">1962 - Sekine & Hayashi on the TOSBAC</li>
<li class="fragment">1964 - Moog & Deutsch with prototype synthesizers; Don Buchla creates the first commercial analog sequencer on the Buchla 100</li>
<li class="fragment">1969 - Max Mathews GROOVE on a Honeywell DDP-24; Peter Zinovieff MUSYS on PDP-8s</li>
<li class="fragment">1971 - EMS releases first digital sequencer</li>
</ul>

[//]: Speaker-Notes:


## Background (generative music)

<ul>
<li class="fragment">1957 - Max Mathews MUSIC-1 on the IBM 704</li>
<li class="fragment">(1958 - LISP, also on the IBM 704)</li>
<li class="fragment">1962 - Sekine & Hayashi on the TOSBAC</li>
<li class="fragment">1964 - Moog & Deutsch with prototype synthesizers; Don Buchla creates the first commercial analog sequencer on the Buchla 100</li>
<li class="fragment">1969 - Max Mathews GROOVE on a Honeywell DDP-24; Peter Zinovieff MUSYS on PDP-8s</li>
<li class="fragment">1971 - EMS releases first digital sequencer</li>
</ul>

[//]: Speaker-Notes:


## Background (digital music)

<ul>
<li class="fragment">Early 1980s - Musical Interface Digital Interface (MIDI) standard created</li>
<li class="fragment">1990s - Digital music recording took off</li>
<li class="fragment">2000s - Recording on regular PCs</li>
<li class="fragment">Early 2010s - Open Sound Control (OSC) standard created </li>
<li class="fragment">2010s - Digital Audio Workstation (DAW) software, tube/analog emulation, live-coding</li>
</ul>

[//]: Speaker-Notes:


## Erlang & Sound

<ul>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
</ul>

[//]: Speaker-Notes:


## Extempore vs. SuperCollider

<ul>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
<li class="fragment">XXX</li>
</ul>

[//]: Speaker-Notes:


## undertone

What is it good for?

[//]: Speaker-Notes:


## Review

* {{< fa check-square >}} Background, sound in the digital world, etc.
* {{< fa check-square >}} Homage: Joe Armstrong's explorations
* {{< fa check-square >}} Extempore vs. SuperCollider
* Lisp Flavoured Erlang 2.0
* Extempore in OTP
* Making Music

[//]: Speaker-Notes:


{{< slide background-image="LFE-logo-darker-greys-0.05trans-6-square-x3000.png" >}}

## LFE

What is it?

```erlang
ackermann(0, N) ->
  N+1;
ackermann(M, 0) ->
  ackermann(M-1, 1);
ackermann(M, N) when M > 0 andalso N > 0 ->
  ackermann(M-1, ackermann(M, N-1)).
```

```clj
(defun ackermann
  ((0 n) (+ n 1))
  ((m 0) (ackermann (- m 1) 1))
  ((m n) (ackermann (- m 1) (ackermann m (- n 1)))))
```

[//]: Speaker-Notes:


## Don't Panic

[//]: Speaker-Notes:


## Q & A Time

[//]: Speaker-Notes:

{{% /note %}}
